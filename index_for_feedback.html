<!DOCTYPE html>
<html>
<body>



<!--Add container at top for Headline and description-->
<div class="container">

  <h1>Does the Danish Football Superliga have a Supporter Attendance Problem?</h1>

  <p>Beginning with the 2016/2017 season of the Premier Danish Football League "SuperLiga", the tournament structure and amount of teams
  participating have been changed. <br> <br>
  Previous seasons have been contested between 12 teams playing each other 3 times in a 33 Round tournament with highest points Team winning the 
  championship and the 2 lowest points Teams being relegated. <br>
  New structure includes 14 teams playing each other twice in a 26 round initial tournament, where Top 6 continue in a Championship "League" of 10 rounds
  and Bottom 8 continue in a Relegation "League"  <br>
  This change is targeting 2 main goals, first and foremost to increase popularity of the tournament and secondly to increase quality level of teams
  for increased success in European Tournaments. <br> <br>
  Initial attendance figures however are not showing an encouraging trend, below chart shows the accumulated attendance split per team/per season when all teams have played 8 matches at home. <br>
  <i> Try clicking individual Team legends to include/exclude in the chart. </i>
  </p>

<!--CSS styling container at top -->
<style>
  

  .container {
  border: 1px solid #dbd6d6;
  padding-left: 15px;
  border-radius: 3px;
  margin-top: 1px;
  margin-bottom: 1px;
  }

  h1 {
  padding-top: 1px;
  margin-top: 1px;
  }


  </style>



</div>

  

<!--add container for chart and load d3 and dimple -->
<div id="chartContainer">
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://dimplejs.org/dist/dimple.v2.2.0.min.js"></script>
  <script type="text/javascript">

  // add svg to chart container  
    var svg = dimple.newSvg("#chartContainer", 1400, 600);

    
      // set chart title in svg
      d3.select('svg')
            .append("text")
            .attr("x", 500)
            .attr("y", 50)
            .style("text-anchor", "middle")
            .style("font-family", "sans-serif")
            .style("font-weight", "bold")
            .style("font-size", "20px")
            .text("Total Attendance first 8 home games");


      // load data      
      d3.tsv("superliga_attendance.tsv", function (data) {


        
        // Create the chart and animations
        var myChart = new dimple.chart(svg, data);
        myChart.setBounds(60, 130, "70%", "70%")

        
        var x = myChart.addCategoryAxis("x", "season");
        x.addOrderRule(["2010/2011", "2011/2012", "2012/2013", "2013/2014", "2014/2015", "2015/2016", "2016/2017"]);
        x.fontSize = "auto";
        var y = myChart.addMeasureAxis("y", "attendance");
        y.fontSize = "auto";
        y.title = "Accumulated Attendance in '000s";
        myChart.addSeries(["home_team"], dimple.plot.bar);
        var myLegend = myChart.addLegend(185, 82, 1000, 90);
        myLegend.fontSize = "15px";
        myChart.ease = "bounce";
        myChart.staggerDraw = true;
        
        myChart.draw(1000);

        // Add total attendance for each season directly above each bar
        // Iterate every value on the x axis
            x.shapes.selectAll("text").each(function (d) {

    // There is a dummy empty string value on the end which we want to ignore
              if (d && d.length) {

        // Get the total y value
                var total = d3.sum(data, function (t) { return (t.season === d ? t.attendance : 0); });
        // Add the text for the label
                var label = svg.append("text");

        // Set the x position
        // x._scale(d) is the tick position of each element
        // (myChart._widthPixels() / x._max) / 2 is half of the space allocated to each element
                label.attr("x", x._scale(d) + (myChart._widthPixels() / x._max) / 2)

        // Vertically center the text on the point
                label.attr("dy", "0.35em")

        // Style the text - this can be better done with label.attr("class", "my-label-class")
                label.style("text-anchor", "middle")
                  .style("font-size", "12px")
                  .style("font-family", "sans-serif")
                  .style("opacity", 0.8)

        // Set the text itself in thousands
                label.text(d3.format(",.1f")(total) + "k");


        // Once the style and the text is set we can set the y position
        // y._scale(total) gives the y position of the total (and therefore the top of the top segment)
        // label.node().getBBox().height gives the height of the text to leave a gap above the bar
                label.attr("y", y._scale(total) - label.node().getBBox().height)
                  }

                

              });

        
        // This is a critical step.  By doing this we orphan the legend. This
        // means it will not respond to graph updates.  Without this the legend
        // will redraw when the chart refreshes removing the unchecked item and
        // also dropping the events we define below.
        myChart.legends = [];

        // Add legend title
        svg.selectAll("title_text")
          .data(["Click legend to","show/hide owners:"])
          .enter()
          .append("text")
            .attr("x", 45)
            .attr("y", function (d, i) { return 90 + i * 14; })
            .style("font-family", "sans-serif")
            .style("font-size", "15px")
            .style("color", "Black")
            .text(function (d) { return d; });

        // Get a unique list of Owner values to use when filtering
        var filterValues = dimple.getUniqueValues(data, "home_team");
        // Get all the rectangles from our now orphaned legend
        myLegend.shapes.selectAll("rect")
          // Add a click event to each rectangle
          .on("click", function (e) {
            // This indicates whether the item is already visible or not
            var hide = false;
            var newFilters = [];
            // If the filters contain the clicked shape hide it
            filterValues.forEach(function (f) {
              if (f === e.aggField.slice(-1)[0]) {
                hide = true;
              } else {
                newFilters.push(f);
              }
            });
            // Hide the shape or show it
            if (hide) {
              d3.select(this).style("opacity", 0.2);
            } else {
              newFilters.push(e.aggField.slice(-1)[0]);
              d3.select(this).style("opacity", 1.0);
            }
            // Update the filters
            filterValues = newFilters;
            // Filter the data
            myChart.data = dimple.filterData(data, "home_team", filterValues);
            
            // remove all bar labels so that they can be created again with new data based on group of legends chosen 
            d3.selectAll("text:nth-child(3)").remove();
            d3.selectAll("text:nth-child(3)").remove();
            d3.selectAll("text:nth-child(3)").remove();
            d3.selectAll("text:nth-child(3)").remove();
            d3.selectAll("text:nth-child(3)").remove();
            d3.selectAll("text:nth-child(3)").remove();
            d3.selectAll("text:nth-child(3)").remove();
            d3.selectAll("text:nth-child(3)").remove();
            d3.selectAll("text:nth-child(3)").remove();
            d3.selectAll("text:nth-child(3)").remove();
            
            // add legend text again as removed together with bar labels
            svg.selectAll("title_text")
              .data(["Click legend to","show/hide owners:"])
              .enter()
              .append("text")
                .attr("x", 45)
                .attr("y", function (d, i) { return 90 + i * 14; })
                .style("font-family", "sans-serif")
                .style("font-size", "15px")
                .style("color", "Black")
                .text(function (d) { return d; });

            myChart.draw(800);    

            // Repeat adding labels to each bar with totals according to chosen legends
            // Iterate every value on the x axis
            x.shapes.selectAll("text").each(function (h) {

    // There is a dummy empty string value on the end which we want to ignore
              if (h && h.length) {

        // Get the total y value
                var total = d3.sum(dimple.filterData(data, "home_team", filterValues), function (q) { 
                  return (q.season === h ? q.attendance : 0); });
        
        // Add the text for the label
                
                var label = svg.append("text");
                

        // Set the x position
        // x._scale(d) is the tick position of each element
        // (myChart._widthPixels() / x._max) / 2 is half of the space allocated to each element
                label.attr("x", x._scale(h) + (myChart._widthPixels() / x._max) / 2)

        // Vertically center the text on the point
                label.attr("dy", "0.35em")

        // Style the text - this can be better done with label.attr("class", "my-label-class")
                label.style("text-anchor", "middle")
                  .style("font-size", "12px")
                  .style("font-family", "sans-serif")
                  .style("opacity", 0.8)

        // Set the text itself in thousands
                
                label.text(d3.format(",.1f")(total) + "k");

        // Once the style and the text is set we can set the y position
        // y._scale(total) gives the y position of the total (and therefore the top of the top segment)
        // label.node().getBBox().height gives the height of the text to leave a gap above the bar
                label.attr("y", y._scale(total) - label.node().getBBox().height)

                  }

              });

            // Passing a duration parameter makes the chart animate. Without
            // it there is no transition
            

            
            
          });
      });


  </script>

<!-- add styling to chartcontainer and specific legend -->

<style>
  
    /* Container Border´s */
  #chartContainer {
  border: 1px solid #dbd6d6;
  border-radius: 3px;
  margin-top: 1px;
  margin-bottom: 1px;
  }



  g.dimple-legend.dimple-extra-teams-16-17 {
  font-style: italic;
  }


  </style>


</body>




</div>

<!-- Add container for conclusion and css styling of same -->

<div class="bottomContainer">

  <h2>Conclusion</h2>

  <p>It is obvious from the analysis that total attendance has decreased in 2016/2017 y-o-y, despite of the new structure. This decrease even more significant when excluding the attendance for "Extra Teams 16/17" <br> so that comparison is like for like on number of teams.
  This shows 2016/2017 attendance to be lower than any other year in the analysis. <br>
  Digging one layer deeper it is noted that the decrease y-o-y is shared by all teams execpt for one "FC Midtjylland" <br>
  However before conclusively labelling the new structure as a failure, it remains to be seen if the "Championship"/"Relegation" part of the new structure will be able to turn the trend when matches are of far more importance. </p>

<style>
  

  .bottomContainer {
  border: 1px solid #dbd6d6;
  padding-left: 15px;
  border-radius: 3px;
  margin-top: 1px;
  margin-bottom: 1px;
  }

  h2 {
  padding-top: 1px;
  margin-top: 1px;
  margin-bottom: 2px;
  }

  

  </style>

</div>

<!-- Add container for glossary and css styling of same -->

<div class="glossaryContainer">

  <h3>Glossary</h3>
  <p><strong><i>Others: </strong></i> This Grouping is comprised of teams who have not partipated in all of the Superliga seasons included in this analysis
  <br> <strong><i>Extra Teams 16/17: </strong></i> This Grouping is comprised of the 2 teams who, had it not been for the new structure adding to 2 teams to the Superliga, would not have participated in the 2016/2017 season</p>

<style>
  

  .glossaryContainer {
  border: 1px solid #dbd6d6;
  padding-left: 15px;
  border-radius: 3px;
  margin-top: 1px;
  margin-bottom: 1px;
  }

  h3 {
  padding-top: 1px;
  padding-bottom: 1px;
  margin-top: 1px;
  margin-bottom: 2px;
  }

  p {
  padding-top: 1px;
  padding-bottom: 1px;
  margin-top: 1px;
  }

  

  </style>

</div>


<!-- Add container for logo's of all teams in the 2016/2017 Season of Superliga -->

<div id="logoContainer">

  <p></p>

  <img src="superliga.png" alt="Superliga" width="42" height="42">
  <img src="fck.png" alt="FCK" width="42" height="42">
  <img src="brondby.png" alt="Brondby" width="42" height="42">
  <img src="fcm.png" alt="FCM" width="42" height="42">
  <img src="ob.png" alt="OB" width="42" height="42">
  <img src="aab.png" alt="AaB" width="42" height="42">
  <img src="fcn.png" alt="FCN" width="42" height="42">
  <img src="sdr.png" alt="SDR" width="42" height="42">
  <img src="sif.png" alt="SIF" width="42" height="42">
  <img src="lbk.png" alt="Lyngby" width="42" height="42">
  <img src="vff.png" alt="Viborg" width="42" height="42">
  <img src="agf.png" alt="AGF" width="42" height="42">
  <img src="rfc.png" alt="Randers" width="42" height="42">
  <img src="efb.png" alt="Esbjerg" width="42" height="42">
  <img src="ach.png" alt="ACH" width="42" height="42">
  <img src="superliga.png" alt="Superliga" width="42" height="42">

<style>
  

  .logoContainer {
  padding-left: 15px;
  padding-top: 10px;
  margin-top: 10px;
  margin-bottom: 10px;
  }


  

  </style>


</div>  


</html>
